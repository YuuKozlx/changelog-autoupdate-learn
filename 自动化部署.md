# 自动化部署

## 安装依赖

```bash
npm install -D semantic-release @semantic-release/changelog @semantic-release/git @semantic-release/github @semantic-release/npm @semantic-release/release-notes-generator
npm install -D conventional-changelog-conventionalcommits @commitlint/config-conventional @commitlint/cli husky
npm install -D cz-git czg
```

可以只安装 czg

## 配置文件.release.config.js

```js
module.exports = {
  branches: ["main"], // 监控的分支
  plugins: [
    "@semantic-release/commit-analyzer",
    {
      preset: "angular",
      releaseRules: [
        { type: "fix", release: "patch" },
        { type: "feat", scope: "minor", release: "minor" },
        { type: "feat", release: "minor" }, // 禁止其他 feat 触发版本
      ],
      parserOpts: {
        noteKeywords: ["BREAKING CHANGE", "BREAKING CHANGES"],
      },
    },
    "@semantic-release/release-notes-generator", // 生成 release notes
    "@semantic-release/changelog", // 更新 CHANGELOG.md
    [
      "@semantic-release/git",
      {
        assets: ["package.json", "CHANGELOG.md"],
        message: "chore(release): ${nextRelease.version}",
      },
    ],
    //'@semantic-release/github' //这个配置了会进行包的发布
  ],
  tagFormat: "v${version}",
};
```

这里的 version 可以不管它，和 git 的 tag 无关，tag 更新不是在这里读取的

## 配置 package.json

```json
{
  "name": "test-auto",
  "version": "1.4.0",
  "devDependencies": {
    "@commitlint/cli": "^19.8.1",
    "@commitlint/config-conventional": "^19.8.1",
    "@semantic-release/changelog": "^6.0.3",
    "@semantic-release/git": "^10.0.1",
    "@semantic-release/github": "^11.0.5",
    "@semantic-release/release-notes-generator": "^14.1.0",
    "conventional-changelog-conventionalcommits": "^9.1.0",
    "czg": "^1.12.0",
    "husky": "^9.1.7"
  },
  "scripts": {
    "prepare-husky": "husky init",
    "husky:add-commit-msg": "echo #!/bin/sh > .husky/commit-msg & echo npx --no-install commitlint --edit ${1} >> .husky/commit-msg",
    "husky:setup": "npm run husky:add-commit-msg",
    "changelog": "conventional-changelog -i CHANGELOG.md -p angular -s -r 0",
    "release": "semantic-release --ci",
    "release-dry": "semantic-release --dry-run",
    "release:local": "semantic-release --no-ci",
    "commit": "czg",
    "prepare": "husky",
    "version:patch": "npm version patch --no-git-tag-version ",
    "version:minor": "npm version minor --no-git-tag-version ",
    "version:major": "npm version major --no-git-tag-version ",
    "release:preview": "semantic-release --dry-run --no-ci",
    "help": "echo ===== npm scripts usage ===== & echo 1. prepare-husky: 初始化 husky 目录，用于 Git hooks & echo 2. husky:add-commit-msg: 创建或覆盖 commit-msg 钩子，校验 commit message 是否符合规范 & echo 3. husky:setup: 一次性设置 commit-msg 钩子 & echo 4. changelog: 根据 commit message 生成或更新 CHANGELOG.md 文件 & echo 5. release: 在 CI/CD 环境中自动发布版本（semantic-release 自动分析 commit message 决定 patch/minor/major，并更新 package.json/CHANGELOG.md、推送 Git tag 和 GitHub release） & echo 6. release-dry: semantic-release dry-run 模式，用于预览自动发布结果，不修改文件或推送 & echo 7. release:local: 在本地运行 semantic-release，用于测试发布流程，不依赖 CI/CD & echo 8. commit: 使用 czg 提交 commit，确保 commit message 符合规范 & echo 9. version:patch/minor/major: 手动 bump 版本，仅用于记忆如何更新版本，不会自动 commit 或 push，只更新本地 package.json.version & echo 10. release:preview: 本地 dry-run 预览 semantic-release 会生成的下一个版本和 release notes，不修改文件或推送 & echo 11. 版本号说明: CI/CD 中 semantic-release 会根据最新 Git tag 和 commit history 计算版本，package.json.version 仅用于本地参考，手动 bump 仅做记忆或测试，不影响 CI/CD 自动发布 & echo WARN: version:patch/minor/major 不会自动提交或推送，谨慎使用"
  },
  "config": {
    "commitizen": {
      "path": "./node_modules/czg",
      "czConfig": "./config/cz.config.js"
    }
  },
  "commitlint": {
    "extends": ["@commitlint/config-conventional"]
  },
  "dependencies": {
    "conventional-changelog-conventionalcommits": "^8.0.0"
  }
}
```

## 配置 commitlint.config.js

```js
module.exports = { extends: ["@commitlint/config-conventional"] };
```

## 配置 husky

```bash
npx husky install
npx husky add .husky/commit-msg 'npx --no-install commitlint --edit $1'
```

.husky/commit-msg 文件内容

```bash
#!/usr/bin/env sh
#. "$(dirname "$0")/h"
npx --no-install commitlint --edit ${1}
```

上述为 commitlint 配置，规范 commit message

## 配置 cz.config.js

```js
// cz.config.js
/** @type {import('cz-git').UserConfig['prompt']} */
module.exports = {
  alias: { fd: "docs: fix typos" },
  messages: {
    type: "Select the type of change that you're committing:",
    scope: "Denote the SCOPE of this change (optional):",
    customScope: "Denote the SCOPE of this change:",
    subject: "Write a SHORT, IMPERATIVE tense description of the change:\n",
    body: 'Provide a LONGER description of the change (optional). Use "|" to break new line:\n',
    breaking:
      'List any BREAKING CHANGES (optional). Use "|" to break new line:\n',
    footerPrefixesSelect:
      "Select the ISSUES type of changeList by this change (optional):",
    customFooterPrefix: "Input ISSUES prefix:",
    footer: "List any ISSUES by this change. E.g.: #31, #34:\n",
    generatingByAI: "Generating your AI commit subject...",
    generatedSelectByAI: "Select suitable subject by AI generated:",
    confirmCommit: "Are you sure you want to proceed with the commit above?",
  },
  types: [
    { value: "feat", name: "feat:     A new feature", emoji: ":sparkles:" },
    { value: "fix", name: "fix:      A bug fix", emoji: ":bug:" },
    {
      value: "docs",
      name: "docs:     Documentation only changes",
      emoji: ":memo:",
    },
    {
      value: "style",
      name: "style:    Changes that do not affect the meaning of the code",
      emoji: ":lipstick:",
    },
    {
      value: "refactor",
      name: "refactor: A code change that neither fixes a bug nor adds a feature",
      emoji: ":recycle:",
    },
    {
      value: "perf",
      name: "perf:     A code change that improves performance",
      emoji: ":zap:",
    },
    {
      value: "test",
      name: "test:     Adding missing tests or correcting existing tests",
      emoji: ":white_check_mark:",
    },
    {
      value: "build",
      name: "build:    Changes that affect the build system or external dependencies",
      emoji: ":package:",
    },
    {
      value: "ci",
      name: "ci:       Changes to our CI configuration files and scripts",
      emoji: ":ferris_wheel:",
    },
    {
      value: "chore",
      name: "chore:    Other changes that don't modify src or test files",
      emoji: ":hammer:",
    },
    {
      value: "revert",
      name: "revert:   Reverts a previous commit",
      emoji: ":rewind:",
    },
  ],
  useEmoji: false,
  emojiAlign: "center",
  useAI: false,
  aiNumber: 1,
  themeColorCode: "",
  scopes: [],
  allowCustomScopes: true,
  allowEmptyScopes: true,
  customScopesAlign: "bottom",
  customScopesAlias: "custom",
  emptyScopesAlias: "empty",
  upperCaseSubject: false,
  markBreakingChangeMode: false,
  allowBreakingChanges: ["feat", "fix"],
  breaklineNumber: 100,
  breaklineChar: "|",
  skipQuestions: [],
  issuePrefixes: [
    { value: "closed", name: "closed:   ISSUES has been processed" },
  ],
  customIssuePrefixAlign: "top",
  emptyIssuePrefixAlias: "skip",
  customIssuePrefixAlias: "custom",
  allowCustomIssuePrefix: true,
  allowEmptyIssuePrefix: true,
  confirmColorize: true,
  maxHeaderLength: Infinity,
  maxSubjectLength: Infinity,
  minSubjectLength: 0,
  scopeOverrides: undefined,
  defaultBody: "",
  defaultIssues: "",
  defaultScope: "",
  defaultSubject: "",
};
```

## 配置 GitHub Actions

这个可以先不管

```yaml
name: Release

on:
  push:
    branches:
      - main # 触发工作流的分支，可以根据需要调整
    tags:
      - "v*" # 如果有版本标签 v1.0.0，也会触发发布

jobs:
  release:
    runs-on: ubuntu-latest # 使用 GitHub 提供的 Ubuntu 虚拟机
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2 # 检出代码

      - name: Set up Node.js
        uses: actions/setup-node@v3 # 设置 Node.js 环境
        with:
          node-version: "20" # 设置你项目所需的 Node.js 版本

      - name: Install dependencies
        run: |
          npm install  # 安装项目依赖

      - name: Set up Git config
        run: |
          git config user.name "GitHub Actions"
          git config user.email "github-actions@github.com"  # 设置 Git 配置

      - name: Run semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # 使用 GitHub 提供的 token 进行发布
        run: |
          npx semantic-release  # 执行 semantic-release 发布
```

## 配置 GitHub Token

- 在 GitHub 仓库的 Settings -> Secrets 中添加一个名为 GITHUB_TOKEN 的 secret，值为一个有 repo 权限的 token。复制后，windows 下需要将 token 保存到环境变量中，否则会报错。格式为 `set GITHUB_TOKEN=token`。

## 发布

- 使用 `npm run commit` 提交代码，按提示输入提交信息
- 使用 `npm run release` 发布新版本
- 如果是第一次发布，需要手动创建第一个版本，例如 `v1.0.0`，并推送到远程仓库

```bash
git tag v1.0.0
git push origin v1.0.0
```

- 如果是后续发布，只需要提交代码，然后等待 GitHub Actions 自动发布
